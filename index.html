<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Drawing Cloud App</title>

<style>
body{margin:0;font-family:Arial}
#toolbar{
  background:#333;color:#fff;padding:8px;
  display:flex;gap:6px;flex-wrap:wrap
}
button{padding:6px 10px}
svg{width:100%;height:90vh;background:#f5f5f5;touch-action:none}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

</head>
<body>

<div id="toolbar">
<button onclick="setTool('line')">Line</button>
<button onclick="setTool('text')">Text</button>
<button onclick="setTool('pan')">Pan</button>
<button onclick="deleteSelected()">Delete</button>
</div>

<svg id="svgCanvas">
  <g id="drawGroup"></g>
</svg>

<script>
// ---------- Firebase Config ----------
const firebaseConfig = {
  apiKey: "AIzaSyBdiUNdzPgK67dfJC_FKR2dmT2NO3sKdmo",
  authDomain: "project-e3d2941a-89ae-42ac-b6f.firebaseapp.com",
  projectId: "project-e3d2941a-89ae-42ac-b6f",
  storageBucket: "project-e3d2941a-89ae-42ac-b6f.firebasestorage.app",
  messagingSenderId: "780017280635",
  appId: "1:780017280635:web:f93c7b1ed903a1b512a4de"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------- Variables ----------
const svg = document.getElementById("svgCanvas");
const drawGroup = document.getElementById("drawGroup");

let tool = "pan";
let drawing = false;
let line;
let selectedElement = null;

// ---------- Tool ----------
function setTool(t){
    tool = t;
}

// ---------- Select Element ----------
function selectElement(el){
    if(selectedElement && selectedElement.tagName==="line"){
        selectedElement.setAttribute("stroke","black");
    }
    selectedElement = el;

    if(el.tagName==="line"){
        el.setAttribute("stroke","red");
    }
}

// ---------- Delete ----------
function deleteSelected(){
    if(selectedElement){
        selectedElement.remove();
        selectedElement = null;
        saveToCloud();
    } else {
        alert("Select element first");
    }
}

// ---------- Line Drawing ----------
svg.addEventListener("pointerdown", e=>{
    if(tool==="line"){
        drawing = true;

        const pt = svg.createSVGPoint();
        pt.x = e.clientX;
        pt.y = e.clientY;
        const p = pt.matrixTransform(svg.getScreenCTM().inverse());

        line = document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("x1",p.x);
        line.setAttribute("y1",p.y);
        line.setAttribute("x2",p.x);
        line.setAttribute("y2",p.y);
        line.setAttribute("stroke","black");
        line.setAttribute("stroke-width","2");

        line.addEventListener("click",ev=>{
            ev.stopPropagation();
            selectElement(line);
        });

        drawGroup.appendChild(line);
    }

    if(tool==="text"){
        const txt = prompt("Enter text");
        if(!txt) return;

        const pt = svg.createSVGPoint();
        pt.x = e.clientX;
        pt.y = e.clientY;
        const p = pt.matrixTransform(svg.getScreenCTM().inverse());

        const text = document.createElementNS("http://www.w3.org/2000/svg","text");
        text.setAttribute("x",p.x);
        text.setAttribute("y",p.y);
        text.textContent = txt;
        text.setAttribute("font-size","16");

        text.addEventListener("click",ev=>{
            ev.stopPropagation();
            selectElement(text);
        });

        drawGroup.appendChild(text);
        saveToCloud();
    }
});

svg.addEventListener("pointermove", e=>{
    if(!drawing) return;

    const pt = svg.createSVGPoint();
    pt.x = e.clientX;
    pt.y = e.clientY;
    const p = pt.matrixTransform(svg.getScreenCTM().inverse());

    line.setAttribute("x2",p.x);
    line.setAttribute("y2",p.y);
});

svg.addEventListener("pointerup", ()=>{
    if(drawing){
        drawing = false;
        saveToCloud();
    }
});

// ---------- Cloud Save ----------
function saveToCloud(){
    db.collection("rooms").doc("main").set({
        svg: drawGroup.innerHTML,
        updated: Date.now()
    });
}

// ---------- Cloud Load ----------
function loadFromCloud(){
    db.collection("rooms").doc("main")
    .onSnapshot(doc=>{
        if(doc.exists){
            drawGroup.innerHTML = doc.data().svg || "";
            attachEvents();
        }
    });
}

// ---------- Reattach events ----------
function attachEvents(){
    drawGroup.querySelectorAll("line,text")
    .forEach(el=>{
        el.addEventListener("click",e=>{
            e.stopPropagation();
            selectElement(el);
        });
    });
}

loadFromCloud();

</script>
</body>
</html>
