<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mobile Site Manager</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root { --primary:#007bff; --tr:#dc3545; --dark:#121212; --gray:#2a2a2a; }
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; touch-action:manipulation; }

body{
font-family:-apple-system, BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
margin:0; background:#1a1a1a; color:white; height:100vh; display:flex; flex-direction:column; overflow:hidden;
}

.room-nav{display:flex; background:#000; padding:8px; gap:8px; border-bottom:2px solid #333;}
.room-tab{flex:1; padding:15px 5px; text-align:center; font-size:12px; font-weight:800; border-radius:8px; cursor:pointer; background:var(--gray); border:1px solid #444; color:#888;}
.room-tab.active{background:var(--tr); color:white; border-color:#fff;}

.top-bar{padding:10px 15px; background:var(--dark); display:flex; justify-content:space-between; align-items:center;}
#room-display{font-size:14px;font-weight:bold;color:#eee;}

#viewport{flex:1; overflow:auto; position:relative; background:#333;}
#workspace{position:relative; transform-origin:0 0; background:white;}
#svg-layer{position:absolute; top:0; left:0; width:100%; height:100%; touch-action:none; z-index:10;}
canvas{display:block;}

.zoom-ctrl{position:fixed; right:15px; bottom:120px; display:flex; flex-direction:column; gap:12px; z-index:30;}
.float-btn{width:55px; height:55px; border-radius:50%; border:none; background:rgba(0,0,0,0.85); color:white; font-size:28px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 15px rgba(0,0,0,0.6); border:1px solid #444;}

.bottom-nav{background:var(--dark); display:grid; grid-template-columns:repeat(5,1fr); padding:10px 5px 30px 5px; border-top:1px solid #333;}
.nav-btn{background:transparent; border:none; color:#888; display:flex; flex-direction:column; align-items:center; gap:6px; font-size:11px; font-weight:600;}
.icon-box{width:50px; height:45px; border-radius:12px; background:var(--gray); display:flex; align-items:center; justify-content:center; font-size:20px;}
.nav-btn.active .icon-box{background:var(--primary); color:white;}
</style>
</head>
<body>

<div class="room-nav">
<div class="room-tab active" data-room="TR" onclick="switchRoom('TR')">TRANSFER<br>ROOM</div>
<div class="room-tab" data-room="LV" onclick="switchRoom('LV')">LV<br>ROOM</div>
<div class="room-tab" data-room="RMU" onclick="switchRoom('RMU')">RMU<br>ROOM</div>
</div>

<div class="top-bar">
<div id="room-display">TRANSFER ROOM</div>
<input type="color" id="colorPicker" value="#ff0000" style="width:45px; height:45px; border:none; cursor:pointer;">
</div>

<div id="viewport">
<div id="workspace">
<canvas id="pdf-canvas"></canvas>
<svg id="svg-layer" xmlns="http://www.w3.org/2000/svg">
<g id="draw-group"></g>
<line id="preview-line" x1="0" y1="0" x2="0" y2="0" stroke-width="3" stroke-dasharray="5,5" style="display:none;"/>
</svg>
</div>
</div>

<div class="zoom-ctrl">
<button class="float-btn" onclick="zoomView(0.4)">+</button>
<button class="float-btn" onclick="zoomView(-0.4)">-</button>
</div>

<nav class="bottom-nav">
<button class="nav-btn active" onclick="setTool('pan')" id="btn-pan"><div class="icon-box">‚úã</div><span>Pan</span></button>
<button class="nav-btn" onclick="setTool('line')" id="btn-line"><div class="icon-box">üìè</div><span>Line</span></button>
<button class="nav-btn" onclick="setTool('text')" id="btn-text"><div class="icon-box">üìù</div><span>Note</span></button>
<button class="nav-btn" onclick="deleteSelected()" id="btn-delete"><div class="icon-box">üóëÔ∏è</div><span>Del</span></button>
<button class="nav-btn" onclick="undo()"><div class="icon-box">‚Ü©Ô∏è</div><span>Undo</span></button>
</nav>

<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBdiUNdzPgK67dfJC_FKR2dmT2NO3sKdmo",
  authDomain: "project-e3d2941a-89ae-42ac-b6f.firebaseapp.com",
  projectId: "project-e3d2941a-89ae-42ac-b6f",
  storageBucket: "project-e3d2941a-89ae-42ac-b6f.firebasestorage.app",
  messagingSenderId: "780017280635",
  appId: "1:780017280635:web:f93c7b1ed903a1b512a4de"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------- PDF.js ---------- */
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
const LOCAL_PDF_PATH = encodeURIComponent("LV room.pdf");

/* ---------- Variables ---------- */
let currentRoom='TR';
let tool='pan';
let scale=1.0;
let isDrawing=false;
let startPt={x:0,y:0};
let appLoaded=false;
let selectedElement=null;

const svgLayer=document.getElementById('svg-layer');
const drawGroup=document.getElementById('draw-group');
const previewLine=document.getElementById('preview-line');
const workspace=document.getElementById('workspace');
const roomDisplay=document.getElementById('room-display');
const colorPicker=document.getElementById('colorPicker');

let roomData = JSON.parse(localStorage.getItem('offline_room_data')) || {
TR:{name:'TRANSFER ROOM',svg:''},
LV:{name:'LV ROOM',svg:''},
RMU:{name:'RMU ROOM',svg:''}
};

/* ---------- Switch Room ---------- */
function switchRoom(id){
if(appLoaded) saveToStorage();

currentRoom=id;

document.querySelectorAll('.room-tab').forEach(t=>t.classList.remove('active'));
document.querySelector(`[data-room="${id}"]`).classList.add('active');

roomDisplay.innerText = roomData[id].name;

// Load cloud + local
db.collection("rooms").doc(id).get().then(doc=>{
if(doc.exists) drawGroup.innerHTML = doc.data().svg || '';
else drawGroup.innerHTML = roomData[id].svg || '';
attachItemEvents();
});

setTool('pan');
appLoaded=true;
}

/* ---------- Load PDF ---------- */
async function loadPDF(){
try{
const pdf = await pdfjsLib.getDocument(LOCAL_PDF_PATH).promise;
const page = await pdf.getPage(1);
const viewport = page.getViewport({scale:2.5});
const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
canvas.width = viewport.width;
canvas.height = viewport.height;
workspace.style.width = viewport.width+'px';
workspace.style.height = viewport.height+'px';
await page.render({canvasContext:ctx,viewport}).promise;
}catch(e){console.error(e);}
}

/* ---------- Tool ---------- */
function setTool(t){
tool = (tool===t && t!=='pan')?'pan':t;
document.querySelectorAll('.nav-btn').forEach(btn=>btn.classList.remove('active'));
document.getElementById('btn-'+tool).classList.add('active');
svgLayer.style.pointerEvents = (tool==='pan') ? 'none' : 'auto';
document.getElementById('viewport').style.overflow = (tool==='pan')?'auto':'hidden';
}

/* ---------- Get Coordinates ---------- */
function getCoords(e){
const rect = svgLayer.getBoundingClientRect();
const clientX = e.clientX || (e.touches?e.touches[0].clientX:0);
const clientY = e.clientY || (e.touches?e.touches[0].clientY:0);
return { x:(clientX-rect.left)/scale, y:(clientY-rect.top)/scale };
}

/* ---------- Drawing ---------- */
svgLayer.onpointerdown=e=>{
if(tool==='pan') return;

const p = getCoords(e);
if(tool==='line'){
isDrawing=true;
startPt=p;
previewLine.setAttribute('x1',p.x);
previewLine.setAttribute('y1',p.y);
previewLine.setAttribute('stroke',colorPicker.value);
previewLine.style.display='block';
}else if(tool==='text'){
const val=prompt("Note:");
if(val) addText(val,p.x,p.y);
}
};

svgLayer.onpointermove=e=>{
if(!isDrawing) return;
const p=getCoords(e);
previewLine.setAttribute('x2',p.x);
previewLine.setAttribute('y2',p.y);
};

svgLayer.onpointerup=e=>{
if(!isDrawing) return;
isDrawing=false;
previewLine.style.display='none';
const p=getCoords(e);
if(Math.hypot(p.x-startPt.x,p.y-startPt.y)>3){
const line=document.createElementNS("http://www.w3.org/2000/svg","line");
line.setAttribute("x1",startPt.x);
line.setAttribute("y1",startPt.y);
line.setAttribute("x2",p.x);
line.setAttribute("y2",p.y);
line.setAttribute("stroke",colorPicker.value);
line.setAttribute("stroke-width",5);
attachItemEvents(line);
drawGroup.appendChild(line);
saveToStorage();
}
};

/* ---------- Add Text ---------- */
function addText(val,x,y){
const text=document.createElementNS("http://www.w3.org/2000/svg","text");
text.setAttribute("x",x);
text.setAttribute("y",y);
text.setAttribute("fill",colorPicker.value);
text.setAttribute("font-size","24");
text.setAttribute("font-weight","bold");
text.textContent=val;
attachItemEvents(text);
drawGroup.appendChild(text);
saveToStorage();
}

/* ---------- Attach Events for Delete ---------- */
function attachItemEvents(el){
el.onclick = e=>{
if(tool==='delete'){ el.remove(); saveToStorage(); }
};
}

/* ---------- Delete Selected ---------- */
function deleteSelected(){
if(selectedElement){
selectedElement.remove();
selectedElement=null;
saveToStorage();
}else{
alert("Click an element first to delete");
}
}

/* ---------- Zoom ---------- */
function zoomView(delta){
scale=Math.max(0.2,Math.min(4,scale+delta));
workspace.style.transform=`scale(${scale})`;
}

/* ---------- Undo ---------- */
function undo(){
const dg=drawGroup;
if(dg.lastChild){ dg.removeChild(dg.lastChild); saveToStorage(); }
}

/* ---------- Save ---------- */
function saveToStorage(){
roomData[currentRoom].svg = drawGroup.innerHTML;
localStorage.setItem('offline_room_data',JSON.stringify(roomData));
db.collection("rooms").doc(currentRoom).set({svg:drawGroup.innerHTML,updated:Date.now()});
}

/* ---------- Load ---------- */
window.onload=()=>{
loadPDF();
switchRoom('TR');
};
</script>
</body>
</html>
